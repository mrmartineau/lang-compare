---
import SectionNavLink from './SectionNavLink.astro'

interface SectionInfo {
  key: string
  title: string
}

interface Props {
  sections: SectionInfo[]
}

const { sections } = Astro.props
---

<nav class="section-nav" aria-label="Section navigation">
  <SectionNavLink sectionId="section-intro" title="Overview" />
  {
    sections.map((section) => (
      <SectionNavLink
        sectionId={`section-${section.key}`}
        title={section.title}
      />
    ))
  }
</nav>

<script>
  import { createActiveSectionTracker } from '../utils/scrollTracking'

  function initSectionNav(nav: HTMLElement): () => void {
    const scrollContainer = document.querySelector(
      '.main-scroll-area',
    ) as HTMLElement | null
    if (!scrollContainer) return () => {}

    const links = nav.querySelectorAll<HTMLAnchorElement>('.section-nav-link')
    const linkMap = new Map<string, HTMLAnchorElement>()
    const sectionIds: string[] = []
    const cleanupFns: (() => void)[] = []

    links.forEach((link) => {
      const id = link.getAttribute('data-section-id')!
      linkMap.set(id, link)
      sectionIds.push(id)
    })

    function setActive(activeId: string) {
      for (const [id, link] of linkMap) {
        if (id === activeId) {
          link.classList.remove(
            'text-[var(--color-text-muted)]',
            'border-transparent',
          )
          link.classList.add(
            'text-[var(--color-text)]',
            'font-medium',
            'border-[var(--color-accent)]',
            'bg-[var(--color-surface)]',
          )
        } else {
          link.classList.add(
            'text-[var(--color-text-muted)]',
            'border-transparent',
          )
          link.classList.remove(
            'text-[var(--color-text)]',
            'font-medium',
            'border-[var(--color-accent)]',
            'bg-[var(--color-surface)]',
          )
        }
      }
    }

    // Smooth scroll on click â€” use scrollIntoView which respects the
    // scroll-margin-top set on .section-anchor elements in CSS.
    links.forEach((link) => {
      const onClick = (e: Event) => {
        e.preventDefault()
        const id = link.getAttribute('data-section-id')!
        const target = document.getElementById(id)
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' })
        }

        const parentDialog = nav.closest('dialog')
        if (parentDialog instanceof HTMLDialogElement) {
          parentDialog.close()
        }
      }

      link.addEventListener('click', onClick)
      cleanupFns.push(() => link.removeEventListener('click', onClick))
    })

    const tracker = createActiveSectionTracker({
      scrollContainer,
      anchorIds: sectionIds,
      initialActiveId: 'section-intro',
      onActiveChange: setActive,
    })

    return () => {
      cleanupFns.forEach((cleanup) => cleanup())
      tracker.disconnect()
    }
  }

  function init() {
    const navs = document.querySelectorAll<HTMLElement>('.section-nav')
    const cleanups = [...navs].map((nav) => initSectionNav(nav))
    return () => {
      cleanups.forEach((cleanup) => cleanup())
    }
  }

  // Run on initial load and on Astro page transitions.
  let cleanup = init()
  document.addEventListener('astro:after-swap', () => {
    cleanup?.()
    cleanup = init()
  })
</script>
