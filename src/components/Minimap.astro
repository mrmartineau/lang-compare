---
interface SectionInfo {
  key: string
  title: string
}

interface Props {
  sections: SectionInfo[]
}

const { sections } = Astro.props

const allSections = [{ key: 'intro', title: 'Overview' }, ...sections]
---

<nav class="minimap" aria-label="Minimap navigation">
  <div class="minimap-viewport" aria-hidden="true"></div>
  <div class="minimap-items">
    {
      allSections.map((section) => (
        <button
          class="minimap-dot"
          data-minimap-section={`section-${section.key}`}
          type="button"
          aria-label={`Jump to ${section.title}`}
        >
          <span class="minimap-bar" />
          <span class="minimap-tooltip">{section.title}</span>
        </button>
      ))
    }
  </div>
</nav>

<script>
  import {
    createActiveSectionTracker,
    getVisibleContentWindow,
  } from '../utils/scrollTracking'

  function initMinimap() {
    const minimap = document.querySelector('.minimap') as HTMLElement | null
    if (!minimap) return () => {}

    const viewport = minimap.querySelector(
      '.minimap-viewport',
    ) as HTMLElement | null
    const dots = minimap.querySelectorAll<HTMLButtonElement>(
      '[data-minimap-section]',
    )
    const scrollContainer = document.querySelector(
      '.main-scroll-area',
    ) as HTMLElement | null

    if (!scrollContainer || !viewport) return () => {}

    const minimapEl = minimap
    const viewportEl = viewport
    const scrollContainerEl = scrollContainer

    const dotMap = new Map<string, HTMLButtonElement>()
    const sectionIds: string[] = []
    const cleanupFns: (() => void)[] = []

    dots.forEach((dot) => {
      const id = dot.getAttribute('data-minimap-section')!
      dotMap.set(id, dot)
      sectionIds.push(id)
    })

    // --- Active section tracking ---
    function setActive(activeId: string) {
      for (const [id, dot] of dotMap) {
        const bar = dot.querySelector('.minimap-bar') as HTMLElement
        if (!bar) continue
        if (id === activeId) {
          bar.classList.add('active')
        } else {
          bar.classList.remove('active')
        }
      }
    }

    const tracker = createActiveSectionTracker({
      scrollContainer: scrollContainerEl,
      anchorIds: sectionIds,
      initialActiveId: 'section-intro',
      onActiveChange: setActive,
    })

    // --- Click to scroll ---
    dots.forEach((dot) => {
      const onClick = () => {
        const id = dot.getAttribute('data-minimap-section')!
        const target = document.getElementById(id)
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' })
        }
      }

      dot.addEventListener('click', onClick)
      cleanupFns.push(() => dot.removeEventListener('click', onClick))
    })

    // --- Viewport indicator ---
    function updateViewportIndicator() {
      const minimapItems = minimapEl.querySelector(
        '.minimap-items',
      ) as HTMLElement | null
      if (!minimapItems) return

      const { scrollHeight, visibleTop, visibleHeight } =
        getVisibleContentWindow(scrollContainerEl)
      const minimapHeight = minimapItems.clientHeight

      if (scrollHeight <= visibleHeight || minimapHeight <= 0) {
        viewportEl.style.display = 'none'
        return
      }

      viewportEl.style.display = ''

      // Map effective visible window to minimap item space.
      const ratio = minimapHeight / scrollHeight
      const indicatorHeight = Math.min(Math.max(visibleHeight * ratio, 12), minimapHeight)
      const rawTop = visibleTop * ratio
      const maxTop = Math.max(minimapHeight - indicatorHeight, 0)
      const indicatorTop = Math.min(Math.max(rawTop, 0), maxTop)

      const itemsOffset = minimapItems.offsetTop

      viewportEl.style.height = `${indicatorHeight}px`
      viewportEl.style.top = `${itemsOffset + indicatorTop}px`
    }

    scrollContainerEl.addEventListener('scroll', updateViewportIndicator, {
      passive: true,
    })
    window.addEventListener('resize', updateViewportIndicator, {
      passive: true,
    })
    cleanupFns.push(() =>
      scrollContainerEl.removeEventListener('scroll', updateViewportIndicator),
    )
    cleanupFns.push(() =>
      window.removeEventListener('resize', updateViewportIndicator),
    )

    // Initial state
    updateViewportIndicator()
    tracker.refresh()

    return () => {
      cleanupFns.forEach((cleanup) => cleanup())
      tracker.disconnect()
    }
  }

  let cleanup = initMinimap()
  document.addEventListener('astro:after-swap', () => {
    cleanup?.()
    cleanup = initMinimap()
  })
</script>

<style>
  .minimap {
    position: sticky;
    top: var(--header-height);
    right: 0;
    height: calc(100vh - var(--header-height));
    width: 32px;
    min-width: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 15;
    background-color: var(--color-surface-alt);
    border-left: 1px solid var(--color-border);
  }

  .minimap-viewport {
    position: absolute;
    left: 0;
    width: 100%;
    background-color: var(--color-accent);
    opacity: 0.08;
    pointer-events: none;
    transition:
      top 0.1s ease-out,
      height 0.1s ease-out;
    z-index: 0;
  }

  .minimap-items {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 8px 0;
    width: 100%;
    position: relative;
    z-index: 1;
  }

  .minimap-dot {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 10px;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
  }

  .minimap-bar {
    display: block;
    width: 16px;
    height: 3px;
    background-color: var(--color-border);
    transition:
      background-color 0.15s ease,
      transform 0.15s ease;
  }

  .minimap-bar.active {
    background-color: var(--color-accent);
    transform: scaleX(1.25);
  }

  .minimap-dot:hover .minimap-bar {
    background-color: var(--color-accent-hover);
    transform: scaleX(1.4);
  }

  .minimap-tooltip {
    position: absolute;
    right: calc(100% + 6px);
    top: 50%;
    transform: translateY(-50%);
    white-space: nowrap;
    font-size: 0.6875rem;
    line-height: 1;
    padding: 3px 6px;
    background-color: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s ease;
    z-index: 20;
  }

  .minimap-dot:hover .minimap-tooltip {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .minimap {
      display: none;
    }
  }
</style>
