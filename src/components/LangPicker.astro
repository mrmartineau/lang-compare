---
import LangPickerItem from './LangPickerItem.astro'

interface LangInfo {
  slug: string
  name: string
  category: string
}

interface CategoryInfo {
  label: string
  color: string
}

interface Props {
  languages: LangInfo[]
  categories: Record<string, CategoryInfo>
}

const { languages, categories } = Astro.props

// Group languages by category
const grouped = new Map<string, LangInfo[]>()
for (const lang of languages) {
  const cat = lang.category
  if (!grouped.has(cat)) grouped.set(cat, [])
  grouped.get(cat)!.push(lang)
}

const groupEntries = [...grouped.entries()]
---

<div
  class="lang-picker flex flex-col gap-3"
  data-languages={JSON.stringify(languages)}
>
  {
    groupEntries.map(([catKey, langs], groupIndex) => {
      const catInfo = categories[catKey]
      return (
        <>
          <div class="flex flex-col gap-1">
            <span class="flex items-center gap-1 text-xs text-text-muted mr-1 whitespace-nowrap">
              <span
                class="inline-block w-2 h-2 shrink-0"
                style={`background-color: ${catInfo?.color ?? '#888'};`}
              />
              <span>{catInfo?.label ?? catKey}</span>
            </span>
            <div class="flex gap-2 flex-wrap">
              {langs.map((lang) => (
                <LangPickerItem slug={lang.slug} name={lang.name} />
              ))}
            </div>
          </div>
          {/* {groupIndex < groupEntries.length - 1 && (
            <span class="w-px h-5 bg-border" data-lang-group-separator />
          )} */}
        </>
      )
    })
  }
</div>

<script>
  const STORAGE_KEY = 'lang-compare-hidden'

  function parseLanguages(
    pickers: HTMLElement[],
  ): { slug: string; name: string; category: string }[] {
    const firstWithData = pickers.find((picker) =>
      picker.hasAttribute('data-languages'),
    )
    if (!firstWithData) return []
    const langData = firstWithData.getAttribute('data-languages')
    if (!langData) return []
    return JSON.parse(langData)
  }

  function readHiddenLangs(allSlugs: Set<string>): Set<string> {
    let hiddenLangs = new Set<string>()
    const stored = localStorage.getItem(STORAGE_KEY)
    if (stored) {
      try {
        const parsed = JSON.parse(stored)
        if (Array.isArray(parsed)) {
          hiddenLangs = new Set(
            parsed.filter((slug: string) => allSlugs.has(slug)),
          )
        }
      } catch {
        // ignore invalid stored data
      }
    }
    return hiddenLangs
  }

  function init() {
    const pickers = [...document.querySelectorAll<HTMLElement>('.lang-picker')]
    if (pickers.length === 0) return

    const languages = parseLanguages(pickers)
    if (languages.length === 0) return

    const allSlugs = new Set(languages.map((l) => l.slug))
    let hiddenLangs = readHiddenLangs(allSlugs)

    // Guarantee at least one visible language
    if (languages.length > 0 && hiddenLangs.size >= languages.length) {
      hiddenLangs.delete(languages[0].slug)
    }

    function getVisibleCount(): number {
      return languages.filter((l) => !hiddenLangs.has(l.slug)).length
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...hiddenLangs]))
    }

    function applyVisibility() {
      // Sync checkbox states in every picker instance.
      pickers.forEach((picker) => {
        const toggles =
          picker.querySelectorAll<HTMLLabelElement>('[data-lang-toggle]')
        toggles.forEach((label) => {
          const slug = label.getAttribute('data-lang-toggle')!
          const checkbox = label.querySelector('input') as HTMLInputElement
          checkbox.checked = !hiddenLangs.has(slug)
        })
      })

      // Hide/show all cells for each language
      for (const lang of languages) {
        const cells = document.querySelectorAll(
          `[data-lang="${lang.slug}"]`,
        ) as NodeListOf<HTMLElement>
        const isHidden = hiddenLangs.has(lang.slug)
        cells.forEach((cell) => {
          cell.style.display = isHidden ? 'none' : ''
        })
      }

      // Update grid-template-columns
      const visibleCount = getVisibleCount()
      const colStyle = `repeat(${visibleCount}, minmax(350px, 1fr))`
      const grid = document.querySelector(
        '.comparison-grid',
      ) as HTMLElement | null
      if (grid) {
        grid.style.gridTemplateColumns = colStyle
      }
      const headers = document.querySelector(
        '.lang-headers',
      ) as HTMLElement | null
      if (headers) {
        headers.style.gridTemplateColumns = colStyle
      }
    }

    // Attach event listeners across picker instances.
    pickers.forEach((picker) => {
      const toggles =
        picker.querySelectorAll<HTMLLabelElement>('[data-lang-toggle]')
      toggles.forEach((label) => {
        const slug = label.getAttribute('data-lang-toggle')!
        const checkbox = label.querySelector('input') as HTMLInputElement
        if (checkbox.dataset.boundLangPicker === 'true') return
        checkbox.dataset.boundLangPicker = 'true'

        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            hiddenLangs.delete(slug)
          } else {
            // Keep at least one language visible
            if (getVisibleCount() <= 1) {
              checkbox.checked = true
              return
            }
            hiddenLangs.add(slug)
          }
          save()
          applyVisibility()
        })
      })
    })

    // Apply initial visibility
    applyVisibility()
  }

  // Run on initial load and on Astro page transitions
  init()
  document.addEventListener('astro:after-swap', init)
</script>
